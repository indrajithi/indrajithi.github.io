<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Recursive Queries in PostgreSQL for Hierarchical Data | Indrajith Indraprastham</title>
<meta name=keywords content><meta name=description content="Recursive queries are typically used to deal with hierarchical or tree-structured data. A common example is when you have a manager > employee relation in a table and you have to construct the organization tree under a manager or find all N level managers of an employee. Strictly speaking, this process is iteration not recursion, but RECURSIVE is the terminology chosen by the SQL standards committee.
PostgreSQL CTE: Common Table Expression From the docs:"><meta name=author content="Indrajith Indraprastham"><link rel=canonical href=http://localhost:1313/posts/recursive-queries-in-postgresql-for-hierarchial-data/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/recursive-queries-in-postgresql-for-hierarchial-data/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Recursive Queries in PostgreSQL for Hierarchical Data"><meta property="og:description" content="Recursive queries are typically used to deal with hierarchical or tree-structured data. A common example is when you have a manager > employee relation in a table and you have to construct the organization tree under a manager or find all N level managers of an employee. Strictly speaking, this process is iteration not recursion, but RECURSIVE is the terminology chosen by the SQL standards committee.
PostgreSQL CTE: Common Table Expression From the docs:"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/recursive-queries-in-postgresql-for-hierarchial-data/"><meta property="og:image" content="http://localhost:1313/dp.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-14T21:56:55+05:30"><meta property="article:modified_time" content="2022-02-14T21:56:55+05:30"><meta property="og:site_name" content="Indrajith Indraprastham"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/dp.jpg"><meta name=twitter:title content="Recursive Queries in PostgreSQL for Hierarchical Data"><meta name=twitter:description content="Recursive queries are typically used to deal with hierarchical or tree-structured data. A common example is when you have a manager > employee relation in a table and you have to construct the organization tree under a manager or find all N level managers of an employee. Strictly speaking, this process is iteration not recursion, but RECURSIVE is the terminology chosen by the SQL standards committee.
PostgreSQL CTE: Common Table Expression From the docs:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Recursive Queries in PostgreSQL for Hierarchical Data","item":"http://localhost:1313/posts/recursive-queries-in-postgresql-for-hierarchial-data/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Recursive Queries in PostgreSQL for Hierarchical Data","name":"Recursive Queries in PostgreSQL for Hierarchical Data","description":"Recursive queries are typically used to deal with hierarchical or tree-structured data. A common example is when you have a manager \u0026gt; employee relation in a table and you have to construct the organization tree under a manager or find all N level managers of an employee. Strictly speaking, this process is iteration not recursion, but RECURSIVE is the terminology chosen by the SQL standards committee.\nPostgreSQL CTE: Common Table Expression From the docs:","keywords":[],"articleBody":" Recursive queries are typically used to deal with hierarchical or tree-structured data. A common example is when you have a manager \u003e employee relation in a table and you have to construct the organization tree under a manager or find all N level managers of an employee. Strictly speaking, this process is iteration not recursion, but RECURSIVE is the terminology chosen by the SQL standards committee.\nPostgreSQL CTE: Common Table Expression From the docs:\nWITH provides a way to write auxiliary statements for use in a larger query. These statements, which are often referred to as Common Table Expressions or CTEs, can be thought of as defining temporary tables that exist just for one query.\nA common table expression is a temporary result set which you can reference within another SQL statement.\nA useful property of WITH queries is that they are evaluated only once per execution of the parent query, even if they are referred to more than once by the parent query or sibling WITH queries.\nThus, expensive calculations that are needed in multiple places can be placed within a WITH query to avoid redundant work.\nAnother possible application is to prevent unwanted multiple evaluations of functions with side-effects\nSyntax:\nWITH cte_name (column_list) AS ( CTE_query_definition ) statement; Example:\nWITH regional_sales AS ( SELECT region, SUM(amount) AS total_sales FROM orders GROUP BY region ), top_regions AS ( SELECT region FROM regional_sales WHERE total_sales \u003e (SELECT SUM(total_sales)/10 FROM regional_sales) ) SELECT region, product, SUM(quantity) AS product_units, SUM(amount) AS product_sales FROM orders WHERE region IN (SELECT region FROM top_regions) GROUP BY region, product; The above query has two auxiliary statements named regional_sales and top_regions. The output of regional_sales is used in top_regions and the output of top_region is used in the primary SELECT query. We can write the above query without CTE, but it’d require us to write two levels of nested sub-SELECTs It is easier to follow this way and the auxiliary statements are executed only once although they are referenced multiple times. RECURSIVE WITH Using RECURSIVE, a WITH query can refer to its own outupt. Lets took in to an example which counts from 1 to 20:\nWITH RECURSIVE cte AS (SELECT 1 AS n -- anchor member UNION SELECT n + 1 -- recursive member FROM cte WHERE n \u003c 20 -- terminator ) SELECT n FROM cte; n ---- 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 Let’s create some hierarchial data to play with CREATE TABLE employees ( id serial PRIMARY KEY, name VARCHAR NOT NULL, manager_id INT ); INSERT INTO employees (id, name, manager_id) VALUES (1, 'Adam Smith', NULL), (2, 'John Nash', 1), (3, 'Mary Jones', 1), (4, 'Peter Gregery', 2), (5, 'Sam Joey', 3), (6, 'Tim Lee', 4), (7, 'Mohan Lal', 5), (8, 'Will Smith', 6), (10, 'Mohan Rathod', 8); Now lets find all the people working under John Nash. WITH RECURSIVE tree as ( SELECT id, name, manager_id FROM employees WHERE id = 2 UNION SELECT e.id, e.name, e.manager_id FROM employees as e JOIN tree t ON t.id = e.manager_id ) SELECT id, name, manager_id FROM tree; SELECT id, name, manager_id from tree; id | name | manager_id ----+---------------+------------ 2 | John Nash | 1 4 | Peter Gregery | 2 6 | Tim Lee | 4 8 | Will Smith | 6 10 | Mohan Rathod | 8 (5 rows) The first part of the query Anchor Member selects the Manager participant John Nash identified by id = 2 Then we join that result with employees table on t.id = e.manager_id to find all the employees having John Nash as their manager This is repeated until all the results are returned How about all the N level managers of Mohan Rathod? We just need to reverse the condition on the JOIN WITH RECURSIVE tree as ( SELECT id, name, manager_id FROM employees where id = 8 UNION SELECT e.id, e.name, e.manager_id FROM employees as e JOIN tree t ON t.manager_id = e.id ) SELECT id, name, manager_id FROM tree; id | name | manager_id ----+---------------+------------ 8 | Will Smith | 6 6 | Tim Lee | 4 4 | Peter Gregery | 2 2 | John Nash | 1 1 | Adam Smith | (5 rows) How to prevent infinite loop when are cycles in the data The recursive query can run infinitely when there are cycles in the data.\nLets create an infinite loop\nIn the above data if we update the manager_id with id. The manager for the employee will be that employee itself.\nUPDATE employees SET manager_id = 8 where id = 8;\nNow when we try to find all the people working under employees.id = 8 it should run infinitely?\nWITH RECURSIVE tree as ( SELECT id, name, manager_id FROM employees where id = 8 UNION ALL SELECT e.id, e.name, e.manager_id FROM employees as e JOIN tree t ON t.id = e.manager_id ) SELECT id, name, manager_id FROM tree; A helpful trick for testing queries when you are not certain if they might loop is to place a LIMIT in the parent query like this SELECT id, name, manager_id FROM tree limit 10; (Not recommended in Production)\nSometimes, using UNION instead of UNION ALL can remove the infinite loop by discarding rows that duplicate previous output rows. However, often a cycle does not involve output rows that are completely duplicate:\nTake this for example:\nWITH RECURSIVE tree as ( SELECT id, name, manager_id, 1 as depth FROM employees WHERE id = 2 UNION SELECT e.id, e.name, e.manager_id, t.depth + 1 FROM employees as e JOIN tree t ON t.id = e.manager_id ) SELECT id, name, manager_id FROM tree; SELECT id, name, manager_id, depth from tree; id | name | manager_id | depth ----+---------------+------------+------- 2 | John Nash | 1 | 1 4 | Peter Gregery | 2 | 2 6 | Tim Lee | 4 | 3 (3 rows) When we run this query for employees.id = 8 where there is a self referencing cycle, UNION will not solve our problem since each rows returned had distinct depth value You can try this (runs infinitely):\nWITH RECURSIVE tree as ( SELECT id, name, manager_id, 1 as depth FROM employees WHERE id = 8 UNION SELECT e.id, e.name, e.manager_id, t.depth + 1 FROM employees as e JOIN tree t ON t.id = e.manager_id ) SELECT id, name, manager_id FROM tree; To solve this type of problem, we can modify the query like this:\nWITH RECURSIVE tree as ( SELECT id, name, manager_id, 1 as depth, ARRAY[id] as path, false as cycle FROM employees WHERE id = 8 UNION SELECT e.id, e.name, e.manager_id, t.depth + 1, t.path || e.id, e.id = ANY(t.path) FROM employees as e JOIN tree t ON t.id = e.manager_id WHERE NOT t.cycle ) SELECT id, name, manager_id, path, cycle FROM tree; id | name | manager_id | path | cycle ----+--------------+------------+--------+------- 8 | Will Smith | 8 | {8} | f 10 | Mohan Rathod | 8 | {8,10} | f 8 | Will Smith | 8 | {8,8} | t (3 rows) When there are multiple field to be checked to recognize a cycle, use an array of rows.\nWITH RECURSIVE tree as ( SELECT id, name, manager_id, 1 as depth, ARRAY[ROW(id, manager_id)] as path, false as cycle FROM employees WHERE id = 8 UNION ALL SELECT e.id, e.name, e.manager_id, t.depth + 1, t.path || ROW(e.id, e.manager_id), ROW(e.id, e.manager_id) = ANY(t.path) FROM employees as e JOIN tree t ON t.id = e.manager_id WHERE NOT t.cycle ) SELECT id, name, manager_id, path, cycle FROM tree; id | name | manager_id | path | cycle ----+--------------+------------+--------------------+------- 8 | Will Smith | 8 | {\"(8,8)\"} | f 10 | Mohan Rathod | 8 | {\"(8,8)\",\"(10,8)\"} | f 8 | Will Smith | 8 | {\"(8,8)\",\"(8,8)\"} | t (3 rows) Reference:\nhttps://www.postgresqltutorial.com/postgresql-recursive-query/ https://www.postgresql.org/docs/9.1/queries-with.html https://hakibenita.com/be-careful-with-cte-in-postgre-sql ","wordCount":"1318","inLanguage":"en","image":"http://localhost:1313/dp.jpg","datePublished":"2022-02-14T21:56:55+05:30","dateModified":"2022-02-14T21:56:55+05:30","author":{"@type":"Person","name":"Indrajith Indraprastham"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/recursive-queries-in-postgresql-for-hierarchial-data/"},"publisher":{"@type":"Organization","name":"Indrajith Indraprastham","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="< /> (Alt + H)">&lt; /></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives/ title=Archives><span>Archives</span></a></li><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Recursive Queries in PostgreSQL for Hierarchical Data</h1><div class=post-meta><span title='2022-02-14 21:56:55 +0530 IST'>February 14, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Indrajith Indraprastham</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#postgresql-cte-common-table-expression aria-label="PostgreSQL CTE: Common Table Expression">PostgreSQL CTE: Common Table Expression</a></li><li><a href=#recursive-with aria-label="RECURSIVE WITH">RECURSIVE WITH</a></li><li><a href=#lets-create-some-hierarchial-data-to-play-with aria-label="Let&rsquo;s create some hierarchial data to play with">Let&rsquo;s create some hierarchial data to play with</a><ul><li><a href=#now-lets-find-all-the-people-working-under-john-nash aria-label="Now lets find all the people working under John Nash.">Now lets find all the people working under John Nash.</a></li><li><a href=#how-about-all-the-n-level-managers-of-mohan-rathod aria-label="How about all the N level managers of Mohan Rathod?">How about all the N level managers of Mohan Rathod?</a></li><li><a href=#how-to-prevent-infinite-loop-when-are-cycles-in-the-data aria-label="How to prevent infinite loop when are cycles in the data">How to prevent infinite loop when are cycles in the data</a></li></ul></li></ul></div></details></div><div class=post-content><p><img loading=lazy src=/images/recursion_tree.png alt="Recursive Tree"></p><ul><li>Recursive queries are typically used to deal with hierarchical or tree-structured data.</li><li>A common example is when you have a <code>manager > employee</code> relation in a table and you have to construct the organization tree under a manager or find all N level managers of an employee.</li></ul><blockquote><p>Strictly speaking, this process is iteration not recursion, but <code>RECURSIVE</code> is the terminology chosen by the SQL standards committee.</p></blockquote><h2 id=postgresql-cte-common-table-expression>PostgreSQL CTE: Common Table Expression<a hidden class=anchor aria-hidden=true href=#postgresql-cte-common-table-expression>#</a></h2><p>From the <a href=https://www.postgresql.org/docs/10/queries-with.html>docs</a>:</p><blockquote><p><code>WITH</code> provides a way to write auxiliary statements for use in a larger query. These statements, which are often referred to as Common Table Expressions or CTEs, can be thought of as defining temporary tables that exist just for one query.</p></blockquote><blockquote><p>A common table expression is a temporary result set which you can reference within another SQL statement.</p></blockquote><blockquote><p>A useful property of <code>WITH</code> queries is that they are evaluated only once per execution of the parent query, even if they are referred to more than once by the parent query or sibling <code>WITH</code> queries.</p></blockquote><blockquote><p>Thus, expensive calculations that are needed in multiple places can be placed within a <code>WITH</code> query to avoid redundant work.</p></blockquote><blockquote><p>Another possible application is to prevent unwanted multiple evaluations of functions with side-effects</p></blockquote><p><strong>Syntax:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#66d9ef>WITH</span> cte_name (column_list) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>      CTE_query_definition 
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>statement</span>;
</span></span></code></pre></div><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> regional_sales <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> region, <span style=color:#66d9ef>SUM</span>(amount) <span style=color:#66d9ef>AS</span> total_sales
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span> orders
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> region
</span></span><span style=display:flex><span>     ), top_regions <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> region
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span> regional_sales
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> total_sales <span style=color:#f92672>&gt;</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>SUM</span>(total_sales)<span style=color:#f92672>/</span><span style=color:#ae81ff>10</span> <span style=color:#66d9ef>FROM</span> regional_sales)
</span></span><span style=display:flex><span>     )
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> region,
</span></span><span style=display:flex><span>       product,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>SUM</span>(quantity) <span style=color:#66d9ef>AS</span> product_units,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>SUM</span>(amount) <span style=color:#66d9ef>AS</span> product_sales
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> orders
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> region <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> region <span style=color:#66d9ef>FROM</span> top_regions)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> region, product;
</span></span></code></pre></div><hr><ul><li>The above query has two auxiliary statements named <code>regional_sales</code> and <code>top_regions</code>.</li><li>The output of <code>regional_sales</code> is used in <code>top_regions</code> and the output of <code>top_region</code> is used in the primary <code>SELECT</code> query.</li><li>We can write the above query without CTE, but it&rsquo;d require us to write two levels of nested <code>sub-SELECTs</code></li><li>It is easier to follow this way and the auxiliary statements are executed only once although they are referenced multiple times.</li></ul><h2 id=recursive-with>RECURSIVE WITH<a hidden class=anchor aria-hidden=true href=#recursive-with>#</a></h2><ul><li>Using <code>RECURSIVE</code>, a <code>WITH</code> query can refer to its own outupt.</li></ul><p>Lets took in to an example which counts from 1 to 20:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span>  cte
</span></span><span style=display:flex><span><span style=color:#66d9ef>AS</span>     (<span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AS</span> n <span style=color:#75715e>-- anchor member
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>UNION</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> n <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#75715e>-- recursive member
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>FROM</span>   cte
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span>  n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>20</span> <span style=color:#75715e>-- terminator
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      )
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> n
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>   cte;
</span></span></code></pre></div><pre tabindex=0><code> n
----
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
</code></pre><hr><h2 id=lets-create-some-hierarchial-data-to-play-with>Let&rsquo;s create some hierarchial data to play with<a hidden class=anchor aria-hidden=true href=#lets-create-some-hierarchial-data-to-play-with>#</a></h2><p><img loading=lazy src=/images/org.jpg alt=tree></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> employees (
</span></span><span style=display:flex><span>	id serial <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>	name VARCHAR <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>	manager_id INT
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> employees (id, name, manager_id) <span style=color:#66d9ef>VALUES</span> 
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;Adam Smith&#39;</span>, <span style=color:#66d9ef>NULL</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;John Nash&#39;</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;Mary Jones&#39;</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#39;Peter Gregery&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>5</span>, <span style=color:#e6db74>&#39;Sam Joey&#39;</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#39;Tim Lee&#39;</span>, <span style=color:#ae81ff>4</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>7</span>, <span style=color:#e6db74>&#39;Mohan Lal&#39;</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>&#39;Will Smith&#39;</span>, <span style=color:#ae81ff>6</span>),
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#39;Mohan Rathod&#39;</span>, <span style=color:#ae81ff>8</span>);
</span></span></code></pre></div><h3 id=now-lets-find-all-the-people-working-under-john-nash>Now lets find all the people working under <code>John Nash</code>.<a hidden class=anchor aria-hidden=true href=#now-lets-find-all-the-people-working-under-john-nash>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> employees
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.id <span style=color:#f92672>=</span> e.manager_id
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><pre tabindex=0><code>SELECT id, name, manager_id from tree;
 id |     name      | manager_id
----+---------------+------------
  2 | John Nash     |          1
  4 | Peter Gregery |          2
  6 | Tim Lee       |          4
  8 | Will Smith    |          6
 10 | Mohan Rathod  |          8
 (5 rows)
</code></pre><ul><li>The first part of the query <code>Anchor Member</code> selects the Manager participant <code>John Nash</code> identified by <code>id = 2</code></li><li>Then we join that result with <code>employees</code> table on <code>t.id = e.manager_id</code> to find all the employees having <code>John Nash</code> as their manager</li><li>This is repeated until all the results are returned</li></ul><h3 id=how-about-all-the-n-level-managers-of-mohan-rathod>How about all the N level managers of <code>Mohan Rathod</code>?<a hidden class=anchor aria-hidden=true href=#how-about-all-the-n-level-managers-of-mohan-rathod>#</a></h3><ul><li>We just need to reverse the condition on the <code>JOIN</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.manager_id <span style=color:#f92672>=</span> e.id
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><pre tabindex=0><code> id |     name      | manager_id
----+---------------+------------
  8 | Will Smith    |          6
  6 | Tim Lee       |          4
  4 | Peter Gregery |          2
  2 | John Nash     |          1
  1 | Adam Smith    |
(5 rows)
</code></pre><h3 id=how-to-prevent-infinite-loop-when-are-cycles-in-the-data>How to prevent infinite loop when are cycles in the data<a hidden class=anchor aria-hidden=true href=#how-to-prevent-infinite-loop-when-are-cycles-in-the-data>#</a></h3><p>The recursive query can run infinitely when there are cycles in the data.</p><blockquote><p><strong>Lets create an infinite loop</strong></p></blockquote><p>In the above data if we update the manager_id with id. The manager for the employee will be that employee itself.</p><p><code>UPDATE employees SET manager_id = 8 where id = 8;</code></p><p>Now when we try to find all the people working under <code>employees.id = 8</code> it should run infinitely?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.id <span style=color:#f92672>=</span> e.manager_id
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><blockquote><p>A helpful trick for testing queries when you are not certain if they might loop is to place a <code>LIMIT</code> in the parent query like this <code>SELECT id, name, manager_id FROM tree limit 10;</code> <strong>(Not recommended in Production)</strong></p></blockquote><blockquote><p>Sometimes, using <code>UNION</code> instead of <code>UNION ALL</code> can remove the infinite loop by discarding rows that duplicate previous output rows. However, often a cycle does not involve output rows that are completely duplicate:</p></blockquote><p>Take this for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id, <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> depth <span style=color:#66d9ef>FROM</span> employees
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id, t.depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.id <span style=color:#f92672>=</span> e.manager_id
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><pre tabindex=0><code>SELECT id, name, manager_id, depth from tree;
 id |     name      | manager_id | depth
----+---------------+------------+-------
  2 | John Nash     |          1 |     1
  4 | Peter Gregery |          2 |     2
  6 | Tim Lee       |          4 |     3
(3 rows)
</code></pre><ul><li>When we run this query for <code>employees.id = 8</code> where there is a self referencing cycle, <code>UNION</code> will not solve our problem since each rows returned had distinct <code>depth</code> value</li></ul><blockquote><p>You can try this (runs infinitely):</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id, <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> depth <span style=color:#66d9ef>FROM</span> employees
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id, t.depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.id <span style=color:#f92672>=</span> e.manager_id
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><blockquote><p>To solve this type of problem, we can modify the query like this:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id, <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> depth, ARRAY[id] <span style=color:#66d9ef>as</span> path,
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>cycle</span> <span style=color:#66d9ef>FROM</span> employees
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id, t.depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>         t.path <span style=color:#f92672>||</span> e.id, e.id <span style=color:#f92672>=</span> <span style=color:#66d9ef>ANY</span>(t.path)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.id <span style=color:#f92672>=</span> e.manager_id
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>NOT</span> t.<span style=color:#66d9ef>cycle</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id, path, <span style=color:#66d9ef>cycle</span> <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><pre tabindex=0><code> id |     name     | manager_id |  path  | cycle
----+--------------+------------+--------+-------
  8 | Will Smith   |          8 | {8}    | f
 10 | Mohan Rathod |          8 | {8,10} | f
  8 | Will Smith   |          8 | {8,8}  | t
(3 rows)
</code></pre><blockquote><p>When there are multiple field to be checked to recognize a cycle, use an array of rows.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> tree <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id, <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> depth, ARRAY[<span style=color:#66d9ef>ROW</span>(id, manager_id)] <span style=color:#66d9ef>as</span> path,
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>cycle</span> <span style=color:#66d9ef>FROM</span> employees
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> e.id, e.name, e.manager_id, t.depth <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>         t.path <span style=color:#f92672>||</span> <span style=color:#66d9ef>ROW</span>(e.id, e.manager_id),
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>ROW</span>(e.id, e.manager_id) <span style=color:#f92672>=</span> <span style=color:#66d9ef>ANY</span>(t.path)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> employees <span style=color:#66d9ef>as</span> e
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>JOIN</span> tree t
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ON</span> t.id <span style=color:#f92672>=</span> e.manager_id
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>NOT</span> t.<span style=color:#66d9ef>cycle</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> id, name, manager_id, path, <span style=color:#66d9ef>cycle</span> <span style=color:#66d9ef>FROM</span> tree;
</span></span></code></pre></div><pre tabindex=0><code> id |     name     | manager_id |        path        | cycle
----+--------------+------------+--------------------+-------
  8 | Will Smith   |          8 | {&#34;(8,8)&#34;}          | f
 10 | Mohan Rathod |          8 | {&#34;(8,8)&#34;,&#34;(10,8)&#34;} | f
  8 | Will Smith   |          8 | {&#34;(8,8)&#34;,&#34;(8,8)&#34;}  | t
(3 rows)
</code></pre><p>Reference:</p><ol><li><a href=https://www.postgresqltutorial.com/postgresql-recursive-query/>https://www.postgresqltutorial.com/postgresql-recursive-query/</a></li><li><a href=https://www.postgresql.org/docs/9.1/queries-with.html>https://www.postgresql.org/docs/9.1/queries-with.html</a></li><li><a href=https://hakibenita.com/be-careful-with-cte-in-postgre-sql>https://hakibenita.com/be-careful-with-cte-in-postgre-sql</a></li></ol></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=http://localhost:1313/posts/on-habits-and-behavior-change/><span class=title>Next »</span><br><span>On habits and behavior change</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Indrajith Indraprastham</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>